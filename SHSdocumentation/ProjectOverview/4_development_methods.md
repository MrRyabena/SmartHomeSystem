# 4. Методы и этапы проектирования

### [<img src="arrow-left-back.svg" height="20"/> К содержанию](README.md)

- [4.1 Принцип работы](#41-принцип-работы)
- [4.2 Этапы разработки](#42-этапы-разработки)
- [4.3 Подход к проектированию](#43-подход-к-проектированию)
- [4.4 Функции](#44-функции)
- [4.5 Структура Smart Home System](#45-структура-smart-home-system)

## 4.1 Принцип работы

Все много раз слышали, что работа электроники основана на принципе нулей и единиц (Булева алгебра), где сами значения “0” и “1” — на первый взгляд, очень абстрактные понятия “нет сигнала” и “есть сигнал”. Чтобы понять как, основываясь на этом принципе, построить умный дом, надо копнуть чуть поглубже. Рассмотрим упрощенную схему модуля.</br>

![scheme-Attiny13_e](../../schemes/Attiny13_e)

Первое что нужно — это подать на схему питание. Линий питания две:

- **COM (GND, VSS, земля)** — общий вывод питания, относительно него измеряются все остальные потенциалы в схеме.
- **+V (VСС, VIN)** — положительная линия питания, их может быть несколько, рассчитанных на разные напряжения, например, +12V, +5V, +3.3V. Еще бывает отрицательное напряжение (относительно GND, опять же), но с ним обычно работают усилители и компараторы, в большинстве архитектур ЭВМ для логических цепей оно не применяется.

Вторая часть схемы, которая будет управлять модулем — это набор логических элементов. Наш дом — умный, поэтому схема из таких элементов будет непростая. Собрать самостоятельно ее, используя лишь базовые компоненты (резисторы, транзисторы, диоды…) крайне сложно, объемно и не рационально, да к тому же работать стабильно она вряд ли будет. К счастью, проблему уже давно решили и все необходимые цепи собраны в одном небольшом радиокомпоненте — микросхеме.</br>

**Интегральная схема (микросхема)** — это электронная схема, помещенная на полупроводниковой (чаще всего кремниевой) подложке, с помощью фотолитографии. Небольшой корпус может содержать внутри как несложный набор логических элементов, так и целый процессор или контроллер, последний нам и нужен.</br>

**Микроконтроллер** — это микросхема, которая содержит в себе процессор, ОЗУ, ПЗУ и периферийные устройства. Это целый небольшой компьютер, который может выполнять математические операции и управлять другими устройствами с помощью периферии.</br>

Чтобы микроконтроллер мог принимать и выводить какие-то сигналы он оснащен выводами (контактами, пинами) с интерфейсом GPIO (general-purpose input/output). Такие пины могут работать в двух режимах: `INPUT` (вход) и `OUTPUT` (выход).

- В режиме `INPUT` микроконтроллер сравнивает входящий сигнал с землей (GND) и принимает его за 1, если его потенциал больше GND.
- Аналогично в режиме `OUTPUT` микроконтроллер может формировать на определенном контакте "0" или потенциал, равный его напряжению питания.</br>

Теперь логический сигнал от микроконтроллера надо усилить с помощью силовой части схемы (например, транзистора или реле), что позволит управлять нагрузкой (светом, отоплением, чайником…) в режиме on/off (вкл/выкл).</br>

Для того, чтобы управлять мощностью (интенсивностью работы) нагрузки (т.е. яркостью света, температурой нагревателя), необходимо регулировать подаваемое на нее напряжение. В цифровой электронике для этого применяется PWM (ШИМ — широтно-импульсная модуляция). Проще говоря, микроконтроллер очень быстро включает и выключает нагрузку на разные микропромежутки времени, а за счет ее инертности получается плавное регулирование.</br>

Выше был описан принцип работы цифровой электроники, но в арсенале многих микроконтроллеров есть блоки для работы с аналоговой электроникой — ADC (АЦП) и DAC (ЦАП).</br>

- **Аналого-цифровой преобразователь** позволяет микроконтроллеру измерять потенциал входного сигнала в диапазоне от 0, до опорного напряжения (либо задается от отдельного источника, либо совпадает с напряжением питания микроконтроллера) с некоторой точностью, которая зависит от разрядности АЦП. Он используется для считывания информации с датчиков, которые за счет физических эффектов (фотоэффектов, термоэффектов, эффекта Холла и пр.) изменяют напряжение на своем выходе. (Прим. цифровые датчики имеют встроенный АЦП и микроконтроллер для передачи информации по интерфейсам связи).</br>

- **Цифро-аналоговый преобразователь** позволяет изменять потенциал сигнала в некотором диапазоне, он обычно служит для звуковых сигналов либо в качестве "цифровых потенциометров".

Теперь, вдохновившись идеей и понимая принцип работы, можно попробовать создать свою систему. На одной теории дом не построишь, поэтому разработка требует постоянных экспериментов, которые подробно описаны в основной части документации.

## 4.2 Этапы разработки

Первым делом необходимо создать физические устройства для решения задач: управления светом, температурой, измерением параметров погоды и пр. Затем реализуются методы взаимодействия и управления. В итоге – получаем автоматизированную систему. Последний шаг в проектировании – "научить" систему обрабатывать данные и регулировать все устройства корректно в любой ситуации с минимальным вмешательством пользователя.

- Этап I. Проектирование автоматических модулей
  - Определение устройств, процессов и параметров, которые необходимо контролировать.
  - Проектирование электронной части модулей.
  - Определение общей структуры всей системы.
- Этап II. Проектирование ядра (бизнес-логики).
  - Дискретизация задач.
  - Создание шаблонов процессов, задач и конфигураций.
  - Создание шаблонов обработки данных и объектов.
  - Создание протоколов взаимодействия и API.
- Этап III. Разработка библиотеки.
  - Создание удобных инструментов, на основе ядра.
  - Создание удобного интерфейса для программистов.
  - Создание инструментов для автоматической конфигурации системы.
- Этап IV. Объединение модулей в единую систему.
  - Настройка стабильной связи между модулями.
  - Настройка протоколов передачи данных.
  - Проектирование API модулей.
  - Проектирование моделей взаимодействия между модулями.
  - Настройка систем обработки ошибок.
- Этап V. Взаимодействие с пользователем.
  - Определение методов взаимодействия с пользователем.
  - Реализация удобных для пользователя методов управления системой.
  - Разработка GUI.
- Этап VI. Обучение системы саморегулированию.
  - Определение факторов, влияющих на поведение системы.
  - Проектирование сценариев поведения системы.
  - Создание нейронной сети, для автоматического регулирования системы.
- Этап VII. Настройка системы.
  - Отладка всех датчиков и модулей.
  - Оптимизация прошивок.
  - Обучение нейронной сети.
  - Тестирование системы на стабильность.
  - Проверка обработки системой критических ситуаций.

## 4.3 Подход к проектированию

При проектировании выявлено два способа реализации **_Smart Home System_**:

1. Создается один большой модуль, который включает в себя несколько микроконтроллеров, их обвязку, систему питания и подключения устройств. Он реализует все необходимые функции.
2. Создается несколько небольших модулей, каждый из которых контролирует один небольшой блок устройств и процессов, имеет собственную систему питания. Все модули связываются между собой по WiFi и образуют единую систему.</br>

Преимущества первого подхода заключаются в удобстве обслуживания: все находится в одном корпусе, не нужно бегать по всему дому, чтобы что-то подключить или поправить. На этом, как оказалось, плюсы заканчиваются, начинаются проблемы. При создании такого модуля получается большая печатная плата, очень большая и сложная, возникает много трудностей при пайке и выявлении ошибок. Самая большая проблема — огромное количество проводов, которые необходимо протянуть по всему дому. Они постоянно отовсюду вылезают, мешают, стоят дорого и наводят помехи друг на друга.</br>

Второй способ оказался более практичным. Мы можем постепенно создавать небольшие схемы, добавлять, менять или переделывать их. Сигнальные и силовые линии не нужно тянуть по всему дому, все получается аккуратно и компактно.</br>
Первый способ имеет смысл только для реализации каких-то небольших систем, по типу контроллера теплицы или какого-то небольшого помещения. Поэтому Smart Home System основан на втором способе.

## 4.4 Функции

_Выше уже описаны цели и идеи их реализации, здесь речь пойдет более конкретно о задачах, которые можно решить с помощью **Smart Home System**._</br>

- Первое что приходит в голову, когда речь идет об умном доме — автоматическое включение и регулировка освещения. Свет должен включаться, когда это необходимо, выключаться, но только тогда, когда он действительно никому не нужен и плавно регулироваться, постоянно поддерживая одинаковое значение яркости. Еще одна дополнительная функция точно не оставит равнодушными людей, которым приходится рано вставать — будильник-рассвет — комната плавно заливается теплым светом, эмитируя восход солнца.</br>
  Задача достаточно простая и реализуется даже без дополнительных библиотек.

- • Если уж речь зашла об освещении, то можно добавить красоты и технологичности — RGB-подсветку. Тут необходимы инструменты для работы со светодиодами типа **RGB** (обычные четыреxвыводные, где требуется только регулировать яркость каждого канала цвета) и **ARGB** (адресные светодиоды, которые позволяют управлять цветом каждого элемента ленты, независимо от всех остальных). Если первыми можно управлять «вручную», то для адресных точно потребуются дополнительные библиотеки. Когда есть хорошие решения, писать заново библиотеки смысла особого нет, поэтому используя готовую основу в виде пары библиотек останется только создать различные эффекты и режимы работы.

- Климат-контроль. С помощью современных датчиков можно с легкостью отслеживать главные факторы домашнего микроклимата: температуру, уровень влажности и концентрацию углекислого газа. Обрабатывая их, можно настроить регулировку котла или подачу горячей воды, работу увлажнителей воздуха и открывать форточки (или включать систему вентиляции).

- Метеостанция. Измерение температуры, влажности, скорости и направления ветра, атмосферного давления. Обработка полученных результатов и составление прогноза погоды на ближайшее время, рекомендации по одежде и ожидания на день.

- Контроллер теплицы. В доме наверняка есть комнатные растения, а может быть целая теплица или сад. Необходимо реализовать автополив, контроль влажности почвы и досвечивание растений.

- IoT. Реализовать возможность получать данные из интернета, выкладывать их, обмениваться с пользователями различных чат-ботов и другие паттерны Интернета Вещей.

- Smart Bar. Холодильная камера на элементах Пельтье, для охлаждения напитков, чайник с поддержанием температуры воды, автоналиватор напитков.

- Аудиосистема. Качественное проигрывание звука, переключение между колонками, автоматическое воспроизведение, эффекты полного погружения.

## 4.5 Структура Smart Home System

Module — самостоятельная часть Smart Home System, отвечающая за один или несколько процессов (управление устройством, опрос датчиков, работа с интернетом...). В системе может быть бесконечно много модулей, которые реализуют необходимый функционал:

- SmartChandelier — управляет люстрой.
- SmartLighter — управляет настенными светильниками.
- SmartRGB — управляет эффектами RGB-подсветки.
- SmartBar — холодильник на элементах Пельтье для охлаждения напитков.
- SmartTeapot — подогреет чай к нужному времени и будет поддерживать его температуру.
- SmartGarden — обеспечит автополив и досвечивание растений.
- SmartServer — связывает все модули, обрабатывает данные.
  - SmartHomeBot — реализован в сервере, отвечает за Telegram-бота и общение с пользователем.
  - SmartVoiceControl — система голосового управления.
- SmartMedia — акустическая система, домашний кинотеатр, подсветка экранов (Ambilight).
