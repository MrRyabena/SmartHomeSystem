
<a id="8_stageIII"></a>


<a id="9_stageIV"></a>

# 9. Этап IV. Объединение модулей в единую систему

<a id="9-1_connection-organization"></a>

## 9.1 Организация соединения

<a id="9-1-1_network-coverage"></a>

### 9.1.1 Покрытие сети

Все модули Smart Home System обмениваются между собой данными по WiFi. Для стабильной работы всех устройств необходимо обеспечить высокий уровень сигнала общей сети для каждого модуля.</br>

Если помещение небольшое и установлен мощный маршрутизатор (WiFi-роутер), то скорее всего никаких дополнительных действий не потребуется. В противном случае, проблему можно решить путем установки WiFi-repeater’ов. Они подключаются в сеть, увеличивают ее радиус покрытия и уровень сигнала.</br>

Вторым шагом необходимо научить все устройства находить друг друга в сети. Для этого им надо раздать статические IP-адреса. Такой адрес привязывается к MAC-адресу платы (он идет с завода, но при желании можно поменять). Делается все в настройках роутера, процедура несложная. Теперь, зная IP устройства, можно будет посылать и принимать данные.</br>

Для удобства настройки в **_Smart Home System_** модули имеют схожие MAC-адреса. Подробнее см. ниже.

<a id="9-1-2_connecting-modules"></a>

### 9.1.2 Подключение модулей

После настройки маршрутизатора, остается подключить и настроить сами микроконтроллеры. Для этого в [SHScore](src/SHScore/) есть набор функций, реализованных в файле [SHSconnectWiFi.h](src/SHScore/SHSconnectWiFi.h).</br>

```c++
namespace shs
{
        // set mac-address SHSma + id:
        // 53:48:53:6D:61:xx xx = 0x(id)
        void setMac(const uint8_t id);

        // set mac-address
        void setMac(const uint8_t *mac);

        // wi-fi connection, called 1 time
        // default:
        // ssid = WIFI_SSID
        // pass = WIFI_PASSWORD
        // from the SHSsettings.h
        void connectWiFi(const char *ssid, const char *pass);

        // call constantly, will cause a reboot if the board is
        // disconnected from WiFi for a long time
        void checkReconnection();
};
```

Задать `SSID` и `PASSWORD` сети можно один раз для всех устройств в файле [SHSsettings.h](SHSlibrary/SHSsettings.h).</br>

MAC-адрес для удобства зашифрован кодом `SHSma` (53:48:53:6D:61:) (т.е. сокращение от **Smart Home System MAC Address**), а на последнем месте указывается уникальный `ID` модуля, таким образом устройства удобно отслеживать и настраивать в маршрутизаторе — достаточно изменить только последнее число.</br>

<a id="9-1-3_tcpip"></a>

### 9.1.3 TCP/IP

**TCP/IP** — основной протокол передачи данных в Интернете. Через него организуется соединение между всеми модулями. Для этого в ядре ESP есть классы `WiFiClient` и `WiFiServer`.</br>

На всех модулях создаются объекты класса `WiFiClient`, которые подключаются к серверу. В [SHScore](src/SHScore) есть свой клаcc, но необходимости в нем на данном этапе проекта нет, в отличии от [SHSTcpServer.h](src/SHScore/SHSTcpServer.h), который отвечает за обработку всех клиентов. Подробнее об этих классах было написано выше в [п. 7.2.4 TCP/IP](#7-2-4_tcpip).

<a id="9-2_api"></a>

## 9.2 API

Все устройства связаны и имеют доступ друг к другу. Чтобы они могли запрашивать и принимать данные, нужно определить соответствующие команды и обработчики для них. `API` каждого модуля состоит из перечисления(`enum`), где каждой команде соответствует числовой код. В пакет данных передается команда, а затем дополнительные параметры, если она их требует. В таком же порядке данные и будут расшифровываться на стороне приемника.</br>

Для разработки `API` следует наследоваться от абстрактного класса [`shs::API`](src/SHScore/SHSAPI.h). API имеет смысл разделять на реальные (т.е. непостредственно управляющие устройством) и виртуальные (непосредственно управляющие устройством). API можно написать для управления микроконтроллером или его частью, какой-то библиотекой или сущностью, целым модулем или подсистемой.</br>

Каждому типу API следует задавать свой `shs::settings::shs_ID_t apiID`, для правильной и быстрой расшифровки протоколами передачи данных.

<a id="10_stageV"></a>